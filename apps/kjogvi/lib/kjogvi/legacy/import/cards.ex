defmodule Kjogvi.Legacy.Import.Cards do
  @moduledoc false

  def import(columns_str, rows) do
    columns = columns_str |> Enum.map(&String.to_atom/1)

    cards =
      for row <- rows do
        # time = DateTime.utc_now()

        Enum.zip(columns, row)
        |> Enum.into(%{})
        |> transform_keys
      end

    _ = Kjogvi.Repo.insert_all(Kjogvi.Birding.Card, cards)

    Kjogvi.Repo.query!("SELECT setval('cards_id_seq', (SELECT MAX(id) FROM cards));")
  end

  def truncate do
    _ = Kjogvi.Repo.query!("TRUNCATE cards CASCADE;")
    _ = Kjogvi.Repo.query!("ALTER SEQUENCE cards_id_seq RESTART;")
  end

  defp transform_keys(
         %{
           locus_id: loc_id,
           autogenerated: autogenerated,
           created_at: created_at,
           updated_at: updated_at,
           start_time: start_time
         } = card
       ) do
    {:ok, inserted_at} = DateTime.from_naive(created_at, "Etc/UTC")
    {:ok, update_time} = DateTime.from_naive(updated_at, "Etc/UTC")

    card
    |> Map.drop([:locus_id, :autogenerated, :created_at, :post_id])
    |> Map.put(:location_id, loc_id)
    |> Map.put(:legacy_autogenerated, autogenerated)
    |> Map.put(:inserted_at, inserted_at)
    |> Map.put(:updated_at, update_time)
    |> Map.put(:start_time, convert_start_time(start_time))
  end

  def convert_start_time(""), do: nil
  def convert_start_time(nil), do: nil

  def convert_start_time(str) do
    [hr, min] = String.split(str, ":")
    {:ok, time} = Time.new(String.to_integer(hr), String.to_integer(min), 0)
    time
  end
end
